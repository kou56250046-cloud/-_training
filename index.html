<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç¬èª­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° å®Œå…¨ç‰ˆ v5ï¼ˆå³è„³æ²ˆé»™ï¼‹ãƒ•ã‚©ãƒ³ãƒˆèª¿æ•´ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg-light:#f6f8fa; --text-light:#111;
  --bg-dark:#1e1e1e;  --text-dark:#eee;
  --accent:#1976d2;   --accent2:#ef5350;
  --accent3:#43a047;  --accent4:#ffb300;
  --fs-mult:1; /* ãƒ•ã‚©ãƒ³ãƒˆå€ç‡ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¤‰æ›´ï¼‰ */
}
body{
  font-family:sans-serif;background:var(--bg-light);color:var(--text-light);
  max-width:900px;margin:0 auto;padding:1rem;transition:background .3s,color .3s;
}
body.dark{background:var(--bg-dark);color:var(--text-dark);}
h1,h2{text-align:center;}
button{
  background:var(--accent);color:#fff;border:none;border-radius:5px;
  padding:.5rem 1rem;cursor:pointer;margin:.25rem;
}
button:hover{opacity:.85;}
select,input[type=number],input[type=file]{
  padding:.4rem;margin-top:.3rem;font-size:1rem;display:block;width:100%;box-sizing:border-box;
}
#flashText,#wordFlash{
  text-align:center;font-size:calc(1.8rem * var(--fs-mult));
  margin-top:1rem;min-height:120px;white-space:pre-line;position:relative;
}
#circleArea,#randomArea{
  text-align:center;margin-top:1rem;min-height:120px;white-space:pre-line;position:relative;
  border:1px dashed #ccc;height:300px;border-radius:8px;overflow:hidden;
  font-size:0; /* å­è¦ç´  .letter å´ã§ã‚µã‚¤ã‚ºæŒ‡å®š */
}
#timer,#timerWord,#timerCircle,#timerRandom{
  text-align:center;font-size:1.1rem;
}
#history{border-top:2px solid var(--accent);margin-top:2rem;padding-top:1rem;}
canvas{width:100%!important;max-height:320px;}
.dark-toggle{float:right;background:none;border:1px solid var(--accent);color:var(--accent);}
.dark-toggle:hover{background:var(--accent);color:#fff;}

/* å††å½¢ï¼ãƒ©ãƒ³ãƒ€ãƒ ã®ä¸€æ–‡å­— */
.letter{
  position:absolute;
  transform:translate(-50%,-50%);
  font-family:sans-serif;
  font-size:calc(1.6rem * var(--fs-mult));
}

/* å³è„³æ²ˆé»™ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#silenceOverlay{
  position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;
  z-index:9999;color:#fff;text-align:center;padding:24px;
}
.silence-box{
  max-width:none;   
  width:80%;        
}
.progress-wrap {
  margin: 16px auto 0;
  height: 8px; /* å°‘ã—å¤ªãã—ã¦ã‚‚OK */
  width: 70%;  /* â† è¿½åŠ ï¼šãƒãƒ¼ã‚’é•·ãã™ã‚‹ã€‚80ã€œ90%ãŒè‡ªç„¶ */
  max-width: 720px; /* PCç”¨ã®æœ€å¤§å¹… */
  background: rgba(255,255,255,0.15);
  border-radius: 999px;
  overflow: hidden;
}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#8ec5ff,#fff);transition:width .1s linear;}
.small{font-size:.85rem;opacity:.75;margin-top:6px;}

/* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.settings-row{
  display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin:.5rem 0;
}
@media (max-width:720px){ .settings-row{grid-template-columns:1fr;} }
.label-inline{display:flex;align-items:center;gap:.5rem;}
.small-note{font-size:.9rem;opacity:.75;margin-top:.25rem;}
</style>
</head>
<body>
<h1>ğŸ“š ç¬èª­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
<button class="dark-toggle" id="toggleTheme">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>

<!-- ğŸ”¤ ãƒ•ã‚©ãƒ³ãƒˆå€ç‡ -->
<section>
  <h2>ğŸ”¤ è¡¨ç¤ºã‚µã‚¤ã‚º</h2>
  <label>ãƒ•ã‚©ãƒ³ãƒˆå€ç‡ï¼ˆ0.8ã€œ2.5ï¼‰
    <input type="range" id="fontScale" min="0.8" max="2.5" step="0.05" value="1">
  </label>
  <div class="small-note">
    å¤§ããã™ã‚‹ã¨æ–‡å­—ã®ã€Œå½¢ã®å°è±¡ã€ãŒå¼·ã¾ã‚Šã€é»™èª­ãŒèµ·ã“ã‚Šã«ãããªã‚Šã¾ã™ã€‚
  </div>
</section>
<hr>

<!-- ğŸ§  å³è„³æ²ˆé»™ãƒ¢ãƒ¼ãƒ‰è¨­å®š -->
<section>
  <h2>ğŸ§  å³è„³æ²ˆé»™ãƒ¢ãƒ¼ãƒ‰ï¼ˆéè¨€èªãƒ»æ®‹åƒçµ±åˆï¼‰</h2>
  <div class="settings-row">
    <label class="label-inline">
      <input type="checkbox" id="silenceMode"> æœ‰åŠ¹ã«ã™ã‚‹
    </label>
    <label>æ²ˆé»™ç§’æ•°ï¼ˆæ¨å¥¨3ã€œ5ç§’ï¼‰
      <input type="number" id="silenceSec" value="3" min="1" max="10" step="1">
    </label>
  </div>
  <p class="small-note">
    åˆºæ¿€ã®ã‚ã¨ã«é»’ç”»é¢ã¸åˆ‡ã‚Šæ›¿ãˆã€ã€Œè¨€èªåŒ–ã›ãšã«å½¢ãƒ»é…ç½®ãƒ»æµã‚Œã®å°è±¡ã ã‘ã€ã‚’å‘³ã‚ã†æ™‚é–“ã‚’ã¤ãã‚Šã¾ã™ã€‚
  </p>
</section>
<hr>

<!-- ğŸ§  ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ -->
<section>
<h2>ğŸ§  ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
<input type="file" id="textFile" accept=".txt">
<select id="displayMode">
  <option value="10">10æ–‡å­—</option>
  <option value="15">15æ–‡å­—</option>
  <option value="20">20æ–‡å­—</option>
  <option value="1">1è¡Œ</option>
  <option value="2">2è¡Œ</option>
  <option value="3">3è¡Œ</option>
  <option value="4">4è¡Œ</option>
  <option value="5">5è¡Œ</option>
  <option value="6">æ®µè½</option>
</select>
<label>è¡¨ç¤ºé€Ÿåº¦(ç§’)</label><input type="number" id="flashSpeed" value="1" min="0.1" max="3" step="0.1">
<label>æ™‚é–“(åˆ†)</label><input type="number" id="flashTime" value="2">
<button id="startFlash">é–‹å§‹</button><button id="stopFlash">åœæ­¢</button>
<div id="flashText"></div><div id="timer"></div>
</section><hr>

<!-- ğŸª„ å˜èª -->
<section>
<h2>ğŸª„ å˜èªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
<input type="file" id="wordFile" accept=".txt">
<label>é€Ÿåº¦(ç§’)</label><input type="number" id="wordSpeed" value="0.5" min="0.1" max="3" step="0.1">
<label>æ™‚é–“(åˆ†)</label><input type="number" id="wordTime" value="3">
<button id="startWord">é–‹å§‹</button><button id="stopWord">åœæ­¢</button>
<div id="wordFlash"></div><div id="timerWord"></div>
</section><hr>

<!-- ğŸŒ€ å††å½¢ -->
<section>
<h2>ğŸŒ€ å††å½¢ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
<input type="file" id="circleFile" accept=".txt">
<label>é€Ÿåº¦(ç§’)</label><input type="number" id="circleSpeed" value="1" min="0.1" max="3" step="0.1">
<label>æ™‚é–“(åˆ†)</label><input type="number" id="circleTime" value="2">
<button id="startCircle">é–‹å§‹</button><button id="stopCircle">åœæ­¢</button>
<div id="circleArea"></div><div id="timerCircle"></div>
</section><hr>

<!-- ğŸ² ãƒ©ãƒ³ãƒ€ãƒ  -->
<section>
<h2>ğŸ² ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
<input type="file" id="randomFile" accept=".txt">
<label>é€Ÿåº¦(ç§’)</label><input type="number" id="randomSpeed" value="1" min="0.1" max="3" step="0.1">
<label>æ™‚é–“(åˆ†)</label><input type="number" id="randomTime" value="2">
<button id="startRandom">é–‹å§‹</button><button id="stopRandom">åœæ­¢</button>
<div id="randomArea"></div><div id="timerRandom"></div>
</section><hr>

<!-- ğŸ“ˆ å±¥æ­´ã¨çµ±è¨ˆ -->
<section id="history">
<h2>ğŸ“ˆ å±¥æ­´ã¨çµ±è¨ˆ</h2>
<div style="text-align:center;">
  <button id="togglePeriod">â± æ—¥åˆ¥</button>
  <button id="toggleMode">ğŸ§­ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</button>
  <button id="exportCSV">ğŸ“‚ CSVå‡ºåŠ›</button>
  <button id="resetHistory">ğŸ§¹ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
<div id="stats" style="text-align:center;margin:10px;"></div>
<canvas id="chart"></canvas>
<ul id="historyList"></ul>
</section>

<!-- å³è„³æ²ˆé»™ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆæ–‡å­—ã¯ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ï¼‰ -->
<div id="silenceOverlay" aria-hidden="true">
  <div class="silence-box">
    <div class="progress-wrap">
      <div class="progress-bar" id="silenceBar"></div>
    </div>
    <div class="small" id="silenceCount"></div>
  </div>
</div>

<script>
let flashTimer,flashCountdown,wordTimer,wordCountdown,circleTimer,circleCountdown,randomTimer,randomCountdown,chart;
let textContent="",wordList=[],circleLines=[],randomLines=[];
let chartPeriod="day"; // day, week, month
let chartMode="ãƒ•ãƒ©ãƒƒã‚·ãƒ¥";

const chartEl=document.getElementById("chart");
const stats=document.getElementById("stats");

/* å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
function formatTime(sec){
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function shuffle(s){return s.split("").sort(()=>Math.random()-.5).join("");}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

/* ãƒ•ã‚©ãƒ³ãƒˆå€ç‡ */
const fontScaleEl=document.getElementById("fontScale");
fontScaleEl.addEventListener("input",()=>{
  document.documentElement.style.setProperty("--fs-mult", fontScaleEl.value);
});

/* ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ */
function readFile(input,cb){
  const f=input.files[0];if(!f)return;
  const r=new FileReader();r.onload=e=>cb(e.target.result);r.readAsText(f);
}
document.getElementById("textFile").onchange=e=>readFile(e.target,t=>textContent=t);
document.getElementById("wordFile").onchange=e=>readFile(e.target,t=>wordList=t.split(/\r?\n/).filter(l=>l.trim()));
document.getElementById("circleFile").onchange=e=>readFile(e.target,t=>circleLines=t.split(/\r?\n/).filter(l=>l.trim()));
document.getElementById("randomFile").onchange=e=>readFile(e.target,t=>randomLines=t.split(/\r?\n/).filter(l=>l.trim()));

/* å³è„³æ²ˆé»™ãƒ¢ãƒ¼ãƒ‰ */
const silenceOverlay=document.getElementById("silenceOverlay");
const silenceBar=document.getElementById("silenceBar");
const silenceCount=document.getElementById("silenceCount");
const silenceModeEl=document.getElementById("silenceMode");
const silenceSecEl=document.getElementById("silenceSec");
let silenceLock=false; // é»’ç”»é¢ä¸­ã¯æ¬¡åˆºæ¿€ã‚’å‡ºã•ãªã„

function beginSilence(){
  if(!silenceModeEl.checked || silenceLock) return Promise.resolve();
  silenceLock=true;
  const total=Math.max(1,Math.min(10,Number(silenceSecEl.value)||3));
  let remain=total;
  silenceOverlay.style.display="flex";
  silenceBar.style.width="0%";
  silenceCount.textContent=`${remain} ç§’`;
  const start=performance.now();
  return new Promise(res=>{
    function step(now){
      const t=(now-start)/1000;
      const prog=Math.min(1,t/total);
      silenceBar.style.width=(prog*100).toFixed(1)+"%";
      const left=Math.ceil(total-t);
      if(left!==remain){
        remain=left;
        silenceCount.textContent=`${Math.max(0,remain)} ç§’`;
      }
      if(prog<1){
        requestAnimationFrame(step);
      }else{
        silenceOverlay.style.display="none";
        silenceLock=false;
        res();
      }
    }
    requestAnimationFrame(step);
  });
}

/* === ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ === */
const displayMode=document.getElementById("displayMode");
const flashSpeed=document.getElementById("flashSpeed");
const flashTime=document.getElementById("flashTime");
const flashText=document.getElementById("flashText");
const timer=document.getElementById("timer");

document.getElementById("startFlash").onclick=()=>{
  if(!textContent)return alert("æ–‡ç« ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  startFlash();
};
document.getElementById("stopFlash").onclick=()=>stopFlash("ãƒ•ãƒ©ãƒƒã‚·ãƒ¥",flashTime.value,flashSpeed.value);

function startFlash(){
  clearInterval(flashTimer);clearInterval(flashCountdown);
  let total=Number(flashTime.value)*60, speed=Number(flashSpeed.value)*1000;
  const lines=textContent.split(/\r?\n/).filter(l=>l.trim());
  const mode=Number(displayMode.value);
  let i=0,char=0;
  const flat=textContent.replace(/\r?\n/g,"");

  flashCountdown=setInterval(()=>{
    total--;timer.textContent=formatTime(total);
    if(total<=0)stopFlash("ãƒ•ãƒ©ãƒƒã‚·ãƒ¥",flashTime.value,flashSpeed.value);
  },1000);

  flashTimer=setInterval(()=>{
    if(silenceLock) return;
    let out="";
    if([10,15,20].includes(mode)){
      out=flat.slice(char,char+mode);
      char+=mode;if(char>=flat.length)char=0;
    }else{
      if(i>=lines.length)i=0;
      out=lines.slice(i,i+mode).join("\n");
      i+=mode;
    }
    flashText.textContent=out;
    setTimeout(()=>{flashText.textContent="";},speed*0.8);
    if(silenceModeEl.checked){
      setTimeout(()=>beginSilence(),speed*0.82);
    }
  },speed);
}
function stopFlash(type,dur,spd){
  clearInterval(flashTimer);clearInterval(flashCountdown);
  flashText.textContent="";timer.textContent="åœæ­¢ä¸­";addHistory(type,dur,spd);
}

/* === å˜èª === */
const wordSpeed=document.getElementById("wordSpeed");
const wordTime=document.getElementById("wordTime");
const wordFlash=document.getElementById("wordFlash");
const timerWord=document.getElementById("timerWord");

document.getElementById("startWord").onclick=()=>{
  if(wordList.length===0)return alert("å˜èªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  startWord();
};
document.getElementById("stopWord").onclick=()=>stopWord("å˜èª",wordTime.value,wordSpeed.value);

function startWord(){
  clearInterval(wordTimer);clearInterval(wordCountdown);
  let total=Number(wordTime.value)*60, speed=Number(wordSpeed.value)*1000;

  wordCountdown=setInterval(()=>{
    total--;timerWord.textContent=formatTime(total);
    if(total<=0)stopWord("å˜èª",wordTime.value,wordSpeed.value);
  },1000);

  wordTimer=setInterval(()=>{
    if(silenceLock) return;
    const w=wordList[Math.floor(Math.random()*wordList.length)];
    wordFlash.textContent=shuffle(w);
    setTimeout(()=>{wordFlash.textContent="";},speed*0.8);
    if(silenceModeEl.checked){
      setTimeout(()=>beginSilence(),speed*0.82);
    }
  },speed);
}
function stopWord(type,dur,spd){
  clearInterval(wordTimer);clearInterval(wordCountdown);
  wordFlash.textContent="";timerWord.textContent="åœæ­¢ä¸­";addHistory(type,dur,spd);
}

/* === å††å½¢ === */
const circleSpeed=document.getElementById("circleSpeed");
const circleTime=document.getElementById("circleTime");
const circleArea=document.getElementById("circleArea");
const timerCircle=document.getElementById("timerCircle");

document.getElementById("startCircle").onclick=()=>{
  if(circleLines.length===0)return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  startCircle();
};
document.getElementById("stopCircle").onclick=()=>stopCircle("å††å½¢",circleTime.value,circleSpeed.value);

function startCircle(){
  clearInterval(circleTimer);clearInterval(circleCountdown);
  let total=Number(circleTime.value)*60, speed=Number(circleSpeed.value)*1000;

  circleCountdown=setInterval(()=>{
    total--;timerCircle.textContent=formatTime(total);
    if(total<=0)stopCircle("å††å½¢",circleTime.value,circleSpeed.value);
  },1000);

  circleTimer=setInterval(()=>{
    if(silenceLock) return;
    circleArea.innerHTML="";
    const line=circleLines[Math.floor(Math.random()*circleLines.length)];
    if(!line)return;
    const chars=[...line];
    const w=circleArea.clientWidth,h=circleArea.clientHeight;
    const cx=w/2,cy=h/2,r=Math.min(w,h)*0.35;
    chars.forEach((c,i)=>{
      const a=2*Math.PI*i/chars.length;
      const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);
      const div=document.createElement("div");
      div.textContent=c;
      div.className="letter";
      div.style.left=x+"px";
      div.style.top=y+"px";
      circleArea.appendChild(div);
    });
    setTimeout(()=>{circleArea.innerHTML="";},speed*0.8);
    if(silenceModeEl.checked){
      setTimeout(()=>beginSilence(),speed*0.82);
    }
  },speed);
}
function stopCircle(type,dur,spd){
  clearInterval(circleTimer);clearInterval(circleCountdown);
  circleArea.innerHTML="";timerCircle.textContent="åœæ­¢ä¸­";addHistory(type,dur,spd);
}

/* === ãƒ©ãƒ³ãƒ€ãƒ  === */
const randomSpeed=document.getElementById("randomSpeed");
const randomTime=document.getElementById("randomTime");
const randomArea=document.getElementById("randomArea");
const timerRandom=document.getElementById("timerRandom");

document.getElementById("startRandom").onclick=()=>{
  if(randomLines.length===0)return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  startRandom();
};
document.getElementById("stopRandom").onclick=()=>stopRandom("ãƒ©ãƒ³ãƒ€ãƒ ",randomTime.value,randomSpeed.value);

function startRandom(){
  clearInterval(randomTimer);clearInterval(randomCountdown);
  let total=Number(randomTime.value)*60, speed=Number(randomSpeed.value)*1000;

  randomCountdown=setInterval(()=>{
    total--;timerRandom.textContent=formatTime(total);
    if(total<=0)stopRandom("ãƒ©ãƒ³ãƒ€ãƒ ",randomTime.value,randomSpeed.value);
  },1000);

  randomTimer=setInterval(()=>{
    if(silenceLock) return;
    randomArea.innerHTML="";
    const line=randomLines[Math.floor(Math.random()*randomLines.length)];
    if(!line)return;
    const chars=[...line];
    const w=randomArea.clientWidth,h=randomArea.clientHeight;
    chars.forEach(c=>{
      const div=document.createElement("div");
      div.textContent=c;
      div.className="letter";
      div.style.left=rand(20,w-20)+"px";
      div.style.top=rand(20,h-20)+"px";
      randomArea.appendChild(div);
    });
    setTimeout(()=>{randomArea.innerHTML="";},speed*0.8);
    if(silenceModeEl.checked){
      setTimeout(()=>beginSilence(),speed*0.82);
    }
  },speed);
}
function stopRandom(type,dur,spd){
  clearInterval(randomTimer);clearInterval(randomCountdown);
  randomArea.innerHTML="";timerRandom.textContent="åœæ­¢ä¸­";addHistory(type,dur,spd);
}

/* === å±¥æ­´ === */
function getHistory(){return JSON.parse(localStorage.getItem("trainingHistory")||"[]");}
function saveHistory(d){localStorage.setItem("trainingHistory",JSON.stringify(d));}
function addHistory(type,dur,spd){
  const r={date:new Date().toLocaleString(),type,duration:+dur,speed:+spd};
  const hist=getHistory();hist.push(r);saveHistory(hist);renderHistory();
}
function resetHistory(){
  if(confirm("å±¥æ­´ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem("trainingHistory");
    renderHistory();
  }
}
document.getElementById("resetHistory").onclick=resetHistory;
document.getElementById("exportCSV").onclick=()=>{
  const h=getHistory();if(h.length===0)return alert("å±¥æ­´ãªã—");
  const csv="æ—¥ä»˜,ç¨®é¡,åˆ†,ç§’\n"+h.map(x=>`${x.date},${x.type},${x.duration},${x.speed}`).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="training_history.csv";
  a.click();
};

/* === ã‚°ãƒ©ãƒ• === */
document.getElementById("togglePeriod").onclick=()=>{
  chartPeriod=chartPeriod==="day"?"week":chartPeriod==="week"?"month":"day";
  renderHistory();
};
document.getElementById("toggleMode").onclick=()=>{
  const arr=["ãƒ•ãƒ©ãƒƒã‚·ãƒ¥","å˜èª","å††å½¢","ãƒ©ãƒ³ãƒ€ãƒ "];
  chartMode=arr[(arr.indexOf(chartMode)+1)%arr.length];
  renderHistory();
};

function renderHistory(){
  const hist=getHistory();
  const list=document.getElementById("historyList");
  list.innerHTML=hist.slice(-10).map(x=>`<li>${x.date} - ${x.type} (${x.duration}åˆ†)</li>`).join("");
  drawChart(hist);
  updateStats(hist);
}
function updateStats(hist){
  const modes=["ãƒ•ãƒ©ãƒƒã‚·ãƒ¥","å˜èª","å††å½¢","ãƒ©ãƒ³ãƒ€ãƒ "];
  const now=new Date();
  const startOfWeek=new Date(now);startOfWeek.setDate(now.getDate()-now.getDay());
  const startOfMonth=new Date(now.getFullYear(),now.getMonth(),1);
  const grouped={};
  hist.forEach(h=>{
    const d=new Date(h.date);
    if(!grouped[h.type])grouped[h.type]={day:0,week:0,month:0};
    if(d.toDateString()===now.toDateString())grouped[h.type].day+=h.duration;
    if(d>=startOfWeek)grouped[h.type].week+=h.duration;
    if(d>=startOfMonth)grouped[h.type].month+=h.duration;
  });
  let html="";
  modes.forEach(m=>{
    const g=grouped[m]||{day:0,week:0,month:0};
    html+=`${m}: æ—¥${g.day}åˆ†ï½œé€±${g.week}åˆ†ï½œæœˆ${g.month}åˆ†<br>`;
  });
  stats.innerHTML=html;
}
function drawChart(hist){
  const keyFn=(d)=>{
    const date=new Date(d.date);
    if(chartPeriod==="day")return d.date.split(" ")[0];
    if(chartPeriod==="week"){
      const week=Math.ceil(date.getDate()/7);
      return `${date.getFullYear()}-${date.getMonth()+1}-ç¬¬${week}é€±`;
    }
    return `${date.getFullYear()}-${date.getMonth()+1}æœˆ`;
  };
  const map={};
  hist.filter(x=>x.type===chartMode).forEach(x=>{
    const k=keyFn(x);map[k]=(map[k]||0)+x.duration;
  });
  const labels=Object.keys(map);
  const data=Object.values(map);
  if(chart)chart.destroy();
  chart=new Chart(chartEl.getContext("2d"),{
    type:"bar",
    data:{labels,datasets:[{label:`${chartMode} (${chartPeriod})`,data,backgroundColor:"rgba(25,118,210,0.5)"}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}

/* === å…±é€š === */
document.getElementById("toggleTheme").onclick=()=>document.body.classList.toggle("dark");
renderHistory();
</script>
</body>
</html>
