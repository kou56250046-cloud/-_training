<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç¬èª­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæ–‡å­—æ•°ãƒ¢ãƒ¼ãƒ‰è¿½åŠ ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: sans-serif;
    background: #f6f8fa;
    color: #111;
    margin: 0 auto;
    max-width: 900px;
    padding: 1rem;
    transition: background 0.3s, color 0.3s;
  }
  body.dark { background: #1e1e1e; color: #eee; }
  h1, h2 { text-align: center; }
  button {
    padding: 0.5rem 1rem;
    background: #1976d2;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin: 0.25rem;
  }
  button:hover { opacity: 0.85; }
  select, input[type="number"], input[type="file"] {
    padding: 0.4rem;
    margin-top: 0.3rem;
    font-size: 1rem;
    display: block;
    width: 100%;
    box-sizing: border-box;
  }
  #flashText, #wordFlash {
    text-align: center;
    font-size: 1.5rem;
    margin-top: 1rem;
    white-space: pre-line;
    min-height: 100px;
  }
  #timer, #timerWord {
    text-align: center;
    font-size: 1.1rem;
    margin-top: 0.5rem;
  }
  #history { margin-top: 1.5rem; border-top: 2px solid #1976d2; padding: 10px; }
  #stats { text-align: center; margin: 10px 0; }
  canvas { width: 100% !important; max-height: 300px; }
  .dark-toggle {
    float: right;
    background: none;
    border: 1px solid #1976d2;
    color: #1976d2;
  }
  .dark-toggle:hover { background: #1976d2; color: #fff; }
</style>
</head>
<body>
<h1>ğŸ“š ç¬èª­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
<button class="dark-toggle" id="toggleTheme">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>

<!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° -->
<section>
  <h2>ğŸ§  ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
  <label>æ–‡ç« ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆ.txtï¼‰</label>
  <input type="file" id="textFile" accept=".txt">
  <label>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
  <select id="displayMode">
    <option value="10">10æ–‡å­—</option>
    <option value="15">15æ–‡å­—</option>
    <option value="20">20æ–‡å­—</option>
    <option value="1">1è¡Œ</option>
    <option value="2">2è¡Œ</option>
    <option value="3">3è¡Œ</option>
    <option value="6">æ®µè½</option>
  </select>
  <label>è¡¨ç¤ºé€Ÿåº¦ï¼ˆç§’ï¼‰</label>
  <input type="number" id="flashSpeed" value="1" min="0.2" max="5" step="0.1">
  <label>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
  <input type="number" id="flashTime" value="2" min="1" max="10">
  <button id="startFlash">é–‹å§‹</button>
  <button id="stopFlash">ä¸­æ­¢</button>
  <div id="flashText"></div>
  <div id="timer"></div>
</section>

<hr>

<!-- å˜èªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° -->
<section>
  <h2>ğŸª„ å˜èªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
  <label>å˜èªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆ.txtï¼‰</label>
  <input type="file" id="wordFile" accept=".txt">
  <label>è¡¨ç¤ºé€Ÿåº¦ï¼ˆç§’ï¼‰</label>
  <input type="number" id="wordSpeed" value="0.5" min="0.1" max="2" step="0.1">
  <label>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
  <input type="number" id="wordTime" value="3" min="1" max="10">
  <button id="startWord">é–‹å§‹</button>
  <button id="stopWord">ä¸­æ­¢</button>
  <div id="wordFlash"></div>
  <div id="timerWord"></div>
</section>

<hr>

<!-- å±¥æ­´ãƒ»çµ±è¨ˆãƒ»ã‚°ãƒ©ãƒ• -->
<section id="history">
  <h2>ğŸ“ˆ å±¥æ­´ã¨çµ±è¨ˆ</h2>
  <div id="stats">å…¨æœŸé–“åˆè¨ˆ: 0åˆ†ï½œä»Šæœˆ: 0åˆ†ï½œä»Šé€±: 0åˆ†</div>
  <div style="text-align:center;">
    <button id="exportCSV">ğŸ“‚ å±¥æ­´CSVå‡ºåŠ›</button>
    <button id="resetHistory">ğŸ§¹ å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="toggleChart">ğŸ“Š æœˆæ¬¡â‡„æ—¥æ¬¡åˆ‡æ›¿</button>
  </div>
  <div id="streak" style="text-align:center;margin:10px;">é€£ç¶šæ—¥æ•°: 0æ—¥</div>
  <canvas id="chart"></canvas>
  <ul id="historyList"></ul>
</section>

<script>
let flashTimer, flashCountdown, wordTimer, wordCountdown, chart;
let textContent = "", wordList = [];
let monthlyMode = false;

// === ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ ===
document.getElementById('textFile').addEventListener('change', e=>{
  const reader=new FileReader();
  reader.onload=evt=>textContent=evt.target.result;
  reader.readAsText(e.target.files[0]);
});
document.getElementById('wordFile').addEventListener('change', e=>{
  const reader=new FileReader();
  reader.onload=evt=>wordList=evt.target.result.split(/\r?\n/).filter(w=>w.trim());
  reader.readAsText(e.target.files[0]);
});

// === ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ ===
document.getElementById('startFlash').addEventListener('click', ()=>{
  if(!textContent)return alert("æ–‡ç« ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  let total=Number(flashTime.value)*60, speed=Number(flashSpeed.value)*1000;
  const lines=textContent.split(/\r?\n/).filter(l=>l.trim());
  let i=0, charIndex=0;
  timer.textContent=formatTime(total);
  flashCountdown=setInterval(()=>{total--;timer.textContent=formatTime(total);
    if(total<=0)stopFlash("ãƒ•ãƒ©ãƒƒã‚·ãƒ¥",speed);},1000);

  flashTimer=setInterval(()=>{
    const mode = Number(displayMode.value);
    let output = "";

    if ([10,15,20].includes(mode)) {
      // ğŸ”¹ ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‹ã‚‰é †ã«è¡¨ç¤ºï¼ˆæ–‡å­—æ•°ãƒ¢ãƒ¼ãƒ‰ï¼‰
      const text = textContent.replace(/\r?\n/g, "");
      output = text.slice(charIndex, charIndex + mode);
      charIndex += mode;
      if (charIndex >= text.length) charIndex = 0; // ãƒ«ãƒ¼ãƒ—
    } else {
      // ğŸ”¹ è¡Œå˜ä½è¡¨ç¤º
      if(i>=lines.length)i=0;
      output = lines.slice(i, i + mode).join("\n");
      i += mode;
    }
    flashText.textContent = output;
  }, speed);
});

document.getElementById('stopFlash').addEventListener('click',()=>stopFlash("ãƒ•ãƒ©ãƒƒã‚·ãƒ¥",flashSpeed.value));
function stopFlash(type,speed){
  clearInterval(flashTimer);clearInterval(flashCountdown);
  timer.textContent="åœæ­¢ä¸­";flashText.textContent="";
  addHistory(type,flashTime.value,speed);
}

// === å˜èª ===
document.getElementById('startWord').addEventListener('click', ()=>{
  if(wordList.length==0)return alert("å˜èªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  let total=Number(wordTime.value)*60, speed=Number(wordSpeed.value)*1000;
  timerWord.textContent=formatTime(total);
  wordCountdown=setInterval(()=>{total--;timerWord.textContent=formatTime(total);
    if(total<=0)stopWord("å˜èª",speed);},1000);
  wordTimer=setInterval(()=>{
    const line=wordList[Math.floor(Math.random()*wordList.length)];
    const shuffled=shuffle(line);
    wordFlash.textContent=shuffled;
    setTimeout(()=>wordFlash.textContent="",speed*0.8);
  },speed);
});
document.getElementById('stopWord').addEventListener('click',()=>stopWord("å˜èª",wordSpeed.value));
function stopWord(type,speed){
  clearInterval(wordTimer);clearInterval(wordCountdown);
  timerWord.textContent="åœæ­¢ä¸­";wordFlash.textContent="";
  addHistory(type,wordTime.value,speed);
}

// === å±¥æ­´ãƒ»ã‚°ãƒ©ãƒ• ===ï¼ˆå‰å›åŒæ§˜ï¼‰
function addHistory(type,duration,speed){
  const r={date:new Date().toLocaleString(),type,duration:Number(duration),speed:Number(speed)};
  const hist=JSON.parse(localStorage.getItem("trainingHistory")||"[]");
  hist.push(r);
  localStorage.setItem("trainingHistory",JSON.stringify(hist));
  renderHistory();
}
function renderHistory(){
  const hist=JSON.parse(localStorage.getItem("trainingHistory")||"[]");
  historyList.innerHTML=hist.slice(-10).map(h=>`<li>${h.date} - ${h.type} (${h.duration}åˆ†, ${h.speed}ç§’)</li>`).join("");
  const dates=[...new Set(hist.map(h=>h.date.split(" ")[0]))];
  streak.textContent=`é€£ç¶šæ—¥æ•°: ${calcStreak(dates)}æ—¥`;
  drawChart(hist); updateStats(hist);
}
document.getElementById('exportCSV').addEventListener('click',()=>{
  const hist=JSON.parse(localStorage.getItem("trainingHistory")||"[]");
  if(hist.length==0)return alert("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“");
  const csv="æ—¥ä»˜,ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç¨®é¡,æ™‚é–“(åˆ†),é€Ÿåº¦(ç§’)\n"+hist.map(h=>`${h.date},${h.type},${h.duration},${h.speed}`).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);
  a.download="training_history.csv";a.click();
});
document.getElementById('resetHistory').addEventListener('click',()=>{
  if(confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){localStorage.removeItem("trainingHistory");renderHistory();}
});
function updateStats(hist){
  const total=hist.reduce((a,b)=>a+b.duration,0);
  const now=new Date();
  const month=now.getMonth(), weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());
  const monthSum=hist.filter(h=>new Date(h.date).getMonth()==month).reduce((a,b)=>a+b.duration,0);
  const weekSum=hist.filter(h=>new Date(h.date)>=weekStart).reduce((a,b)=>a+b.duration,0);
  stats.textContent=`å…¨æœŸé–“åˆè¨ˆ: ${total}åˆ†ï½œä»Šæœˆ: ${monthSum}åˆ†ï½œä»Šé€±: ${weekSum}åˆ†`;
}
function drawChart(hist){
  const dataMap={};
  hist.forEach(h=>{
    const d=new Date(h.date);
    const key=monthlyMode?`${d.getFullYear()}-${d.getMonth()+1}`:h.date.split(" ")[0];
    dataMap[key]=(dataMap[key]||0)+h.duration;
  });
  const labels=Object.keys(dataMap), data=Object.values(dataMap);
  if(chart)chart.destroy();
  chart=new Chart(chartEl.getContext("2d"),{
    type:'line',
    data:{labels,datasets:[{label:monthlyMode?'æœˆåˆ¥åˆè¨ˆ(åˆ†)':'æ—¥åˆ¥åˆè¨ˆ(åˆ†)',data,borderColor:'#1976d2',fill:false,tension:0.2}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}
document.getElementById('toggleChart').addEventListener('click',()=>{monthlyMode=!monthlyMode;renderHistory();});

// === å…±é€šé–¢æ•° ===
function shuffle(str){return str.split(/(?<=.)/).sort(()=>Math.random()-0.5).join('');}
function formatTime(sec){const m=Math.floor(sec/60).toString().padStart(2,'0');const s=(sec%60).toString().padStart(2,'0');return `${m}:${s}`;}
function calcStreak(dates){dates.sort((a,b)=>new Date(a)-new Date(b));let s=0,l=null;for(const d of dates){const cur=new Date(d);if(!l)s=1;else{const diff=(cur-l)/(1000*60*60*24);if(diff==1)s++;else if(diff>1)s=1;}l=cur;}return s;}
document.getElementById('toggleTheme').addEventListener('click',()=>document.body.classList.toggle('dark'));
renderHistory();
</script>
</body>
</html>
